<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Make CHICKEN Work With HTTPS On Mac | markx</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-126806740-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Make CHICKEN Work With HTTPS On Mac</h1><a id="logo" href="/.">markx</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Make CHICKEN Work With HTTPS On Mac</h1><div class="post-meta">Sep 3, 2018</div><a class="disqus-comment-count" data-disqus-identifier="2018/09/03/make-chicken-work-with-https-on-mac/" href="/2018/09/03/make-chicken-work-with-https-on-mac/#disqus_thread"></a><div class="post-content"><p>I tried to write a web scraper in CHICKEN Scheme, but it didn’t go well not far from the beginning. I had OpenSSL installed via Homebrew, and installed the <code>http-client</code> and <code>openssl</code> eggs. But when I tried to get the content of an HTTPS website, it showed an error:<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Error: (ssl-do-handshake) ssl: library=SSL routines, function=ssl3_get_server_certificate, reason=certificate verify failed</div><div class="line"></div><div class="line">	Call history:</div><div class="line"></div><div class="line">	intarweb.scm:798: g2624</div><div class="line">	intarweb.scm:775: write-request-line</div><div class="line">	intarweb.scm:749: http-method-&gt;string</div><div class="line">	intarweb.scm:750: uri-common#uri-&gt;string</div><div class="line">	intarweb.scm:751: number-&gt;string</div><div class="line">	intarweb.scm:752: number-&gt;string</div><div class="line">	intarweb.scm:748: string-append</div><div class="line">	intarweb.scm:748: display</div><div class="line">	http-client.scm:571: k776</div><div class="line">	http-client.scm:571: g780</div><div class="line">	http-client.scm:700: close-connection!</div><div class="line">	http-client.scm:225: close-input-port</div><div class="line">	http-client.scm:226: close-output-port</div><div class="line">	http-client.scm:701: max-retry-attempts</div><div class="line">	http-client.scm:702: max-retry-attempts</div><div class="line">	http-client.scm:705: raise	  	&lt;--</div></pre></td></tr></table></figure></p>
<p>The problem is from the setup between the openssl egg and the OpenSSL library. Because Apple has deprecated use of OpenSSL in favor of its own TLS and crypto libraries, the OpenSSL from Homebrew is not symlinked into the standard location, and its CA file is put at <code>/usr/local/etc/openssl/cert.pem</code>. And the openssl egg doesn’t know to look at this location.</p>
<p>So to make it work, we need to make sure that the openssl egg uses this CA file. I didn’t find a compiler option or some arguments to config this, so I had to change the egg’s code to make it work.</p>
<p>Get the openssl egg’s source code, and edit <code>openssl.scm</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ chicken-install -r openssl</div><div class="line">$ <span class="built_in">cd</span> openssl</div><div class="line">$ open openssl.scm</div></pre></td></tr></table></figure>
<p>In the function <code>ssl-make-client-context*</code>, there is the code:<br><figure class="highlight scheme"><table><tr><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">ssl-make-client-context*</span> #!key (<span class="name">protocol</span> <span class="symbol">'tlsv12</span>) (<span class="name">cipher-list</span> <span class="string">"DEFAULT"</span>) certificate private-key (<span class="name">private-key-type</span> <span class="symbol">'rsa</span>) private-key-asn1? certificate-authorities certificate-authority-directory (<span class="name">verify?</span> <span class="literal">#t</span>))</div><div class="line">  (<span class="name"><span class="builtin-name">unless</span></span> (<span class="name"><span class="builtin-name">or</span></span> certificate-authorities certificate-authority-directory)</div><div class="line">    (<span class="name"><span class="builtin-name">set!</span></span> certificate-authority-directory (<span class="name">ssl-default-certificate-authority-directory</span>)))</div><div class="line">    </div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>This means if neither the CA file, or the CA directory is available, it uses the default CA directory. And we can do something similar: in addition to using the default CA directory, we just specify the CA file:</p>
<figure class="highlight scheme"><table><tr><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">define</span></span> ssl-default-certificate-authorities</div><div class="line">  (<span class="name">make-parameter</span> <span class="string">"/usr/local/etc/openssl/cert.pem"</span>))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">define</span></span> (<span class="name">ssl-make-client-context*</span> #!key (<span class="name">protocol</span> <span class="symbol">'tlsv12</span>) (<span class="name">cipher-list</span> <span class="string">"DEFAULT"</span>) certificate private-key (<span class="name">private-key-type</span> <span class="symbol">'rsa</span>) private-key-asn1? certificate-authorities certificate-authority-directory (<span class="name">verify?</span> <span class="literal">#t</span>))</div><div class="line">  (<span class="name"><span class="builtin-name">unless</span></span> (<span class="name"><span class="builtin-name">or</span></span> certificate-authorities certificate-authority-directory)</div><div class="line">    (<span class="name"><span class="builtin-name">set!</span></span> certificate-authority-directory (<span class="name">ssl-default-certificate-authority-directory</span>)))</div><div class="line">  (<span class="name"><span class="builtin-name">unless</span></span> certificate-authorities</div><div class="line">    (<span class="name"><span class="builtin-name">set!</span></span> certificate-authorities (<span class="name">ssl-default-certificate-authorities</span>)))</div><div class="line"></div><div class="line">     ...</div></pre></td></tr></table></figure>
<p>Then in the source code directory, install the modified local version:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ chicken-install -t <span class="built_in">local</span> <span class="_">-l</span> .</div></pre></td></tr></table></figure>
<p>And that’s it. Now the http-client egg should work with HTTPS sites.</p>
</div><div class="tags"><a href="/tags/chicken/">chicken</a><a href="/tags/scheme/">scheme</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://markx.github.io/2018/09/03/make-chicken-work-with-https-on-mac/';
    this.page.identifier = '2018/09/03/make-chicken-work-with-https-on-mac/';
    this.page.title = 'Make CHICKEN Work With HTTPS On Mac';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//markwithk.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//markwithk.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://markwithk.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://markx.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/chicken/" style="font-size: 15px;">chicken</a> <a href="/tags/scheme/" style="font-size: 15px;">scheme</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/make-chicken-work-with-https-on-mac/">Make CHICKEN Work With HTTPS On Mac</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//markwithk.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">markx.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>